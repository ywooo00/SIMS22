<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>팝업 관리</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.ckeditor.com/ckeditor5/40.2.0/classic/ckeditor.js"></script>
  <style>
    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    /* 커스텀 스크롤바 */
    .custom-scrollbar::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    /* CKEditor 높이 조정 */
    .ck-editor__editable {
      min-height: 250px;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div class="h-screen flex flex-col">
    <!-- 헤더 -->
    <div class="bg-white border-b border-gray-200 px-6 py-4 shrink-0">
      <div class="flex items-center justify-between">
        <h1 class="text-xl font-bold text-gray-900">팝업 관리</h1>
        <div class="text-sm text-gray-500">
          HOME &gt; 관리자 &gt; <span class="font-medium text-gray-900">팝업관리</span>
        </div>
      </div>
    </div>

    <!-- 검색 조건 -->
    <div class="bg-white border-b border-gray-200 px-6 py-4 shrink-0">
      <div class="bg-gray-50 rounded-lg border border-gray-200 p-4" style="display:flex; justify-content: space-between; gap:20px;">
        <div class="flex items-center gap-4"  style="flex:1">
          <div class="w-28">
            <label class="block text-xs text-gray-500 mb-1">검색조건</label>
            <select
              id="search-type"
              class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500"
            >
              <option value="title">제목</option>
              <option value="author">등록자</option>
              <option value="content">내용</option>
            </select>
          </div>
          <div class="flex-1">
            <label class="block text-xs text-gray-500 mb-1">검색어</label>
            <div class="relative">
              <input
                type="text"
                id="search-keyword"
                placeholder="검색어를 입력하세요"
                class="w-full border border-gray-300 rounded px-3 py-2 pl-9 text-sm focus:ring-2 focus:ring-blue-500"
              />
              <svg class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>
          </div>
          <div class="w-36">
            <label class="block text-xs text-gray-500 mb-1">노출 사이트</label>
            <select
              id="search-site"
              class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500"
            >
              <option value="">전체</option>
              <option value="TG">TG</option>
              <option value="TG&Co">TG&Co</option>
              <option value="EPSON">EPSON</option>
              <option value="FUJI XEROX">FUJI XEROX</option>
              <option value="Amway">Amway</option>
              <option value="Huawei">Huawei</option>
              <option value="ZTE">ZTE</option>
              <option value="Lenovo">Lenovo</option>
              <option value="EZVIZ">EZVIZ</option>
              <option value="LOGITECH">LOGITECH</option>
              <option value="이마트">이마트</option>
            </select>
          </div>
          
        </div>
        <div class="flex items-end">
            <button
              onclick="resetSearch()"
              class="flex items-center gap-1 px-3 py-2 text-sm text-gray-600 border border-gray-300 rounded hover:bg-gray-100"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              초기화
            </button>
          </div>
      </div>
    </div>

    <!-- 메인 컨텐츠 -->
    <div class="flex flex-1 overflow-hidden">
      <!-- 왼쪽: 팝업 목록 -->
      <div id="list-panel" class="w-full bg-white flex flex-col h-full transition-all">
        <!-- 목록 헤더 -->
        <div class="px-6 py-3 border-b border-gray-200 flex items-center justify-between shrink-0">
          <div class="flex items-center gap-4"">
            <h2 class="font-semibold text-gray-800 flex items-center gap-2">
              <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
              팝업 목록
            </h2>
            <span class="text-sm text-gray-500">총 <span id="total-count">9</span>건</span>
          </div>
          <div class="flex items-center gap-2">
            <button
              onclick="deleteSelected()"
              id="delete-btn"
              class="px-3 py-1.5 border border-gray-300 text-gray-400 rounded text-xs font-medium"
            >
              삭제 (<span id="selected-count">0</span>)
            </button>
            <button
              onclick="openNewPopup()"
              class="px-3 py-1.5 bg-blue-500 text-white rounded text-xs font-medium hover:bg-blue-600"
            >
              + 신규등록
            </button>
          </div>
        </div>

        <!-- 테이블 -->
        <div class="flex-1 overflow-y-auto custom-scrollbar">
          <table class="w-full text-sm">
            <thead class="bg-gray-50 sticky top-0">
              <tr>
                <th class="w-10 py-3 px-3 border-b border-gray-200">
                  <input
                    type="checkbox"
                    id="select-all"
                    onchange="toggleSelectAll()"
                    class="w-4 h-4 rounded"
                  />
                </th>
                <th class="py-3 px-3 text-left text-gray-600 border-b w-12">No.</th>
                <th class="py-3 px-3 text-left text-gray-600 border-b">제목</th>
                <th class="py-3 px-3 text-left text-gray-600 border-b w-24">등록일</th>
                <th class="py-3 px-3 text-left text-gray-600 border-b w-20">등록자</th>
                <th class="py-3 px-3 text-center text-gray-600 border-b w-16">첨부</th>
                <th class="py-3 px-3 text-center text-gray-600 border-b w-16">조회</th>
                <th class="py-3 px-3 text-center text-gray-600 border-b w-16">상태</th>
              </tr>
            </thead>
            <tbody id="popup-tbody">
              <!-- 동적으로 생성됨 -->
            </tbody>
          </table>

          <!-- 빈 상태 -->
          <div id="empty-state" class="hidden flex items-center justify-center h-40 text-gray-400">
            <div class="text-center">
              <svg class="w-12 h-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              <p class="text-sm">검색 결과가 없습니다</p>
            </div>
          </div>
        </div>

        <!-- 페이지네이션 -->
        <div class="px-6 py-3 border-t border-gray-200 flex items-center justify-between bg-gray-50 shrink-0">
          <span class="text-xs text-gray-500" id="pagination-info">1-9 / 9건</span>
          <div class="flex items-center gap-1" id="pagination-buttons">
            <!-- 동적으로 생성됨 -->
          </div>
        </div>
      </div>

      <!-- 오른쪽: 상세/편집 패널 -->
      <div id="detail-panel" class="hidden w-1/2 bg-gray-50 border-l border-gray-200 flex flex-col h-full">
        <!-- 패널 헤더 -->
        <div class="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between shrink-0">
          <div>
            <h2 class="font-bold text-gray-800" id="detail-title">팝업 수정</h2>
            <p class="text-sm text-gray-500" id="detail-subtitle"></p>
          </div>
          <button
            onclick="closeDetailPanel()"
            class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-400"
          >
            ✕
          </button>
        </div>

        <!-- 패널 바디 -->
        <div class="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar">
          <!-- 기본 정보 -->
          <div class="bg-white rounded-lg border border-gray-200 p-4">
            <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
              <span class="w-1 h-4 bg-blue-500 rounded"></span>
              기본 정보
            </h3>
            <div class="space-y-3">
              <div>
                <label class="block text-xs text-gray-500 mb-1">제목 <span class="text-red-500">*</span></label>
                <input
                  type="text"
                  id="detail-title-input"
                  placeholder="팝업 제목을 입력하세요"
                  class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs text-gray-500 mb-1">등록자</label>
                  <input
                    type="text"
                    id="detail-author"
                    placeholder="등록자"
                    class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 bg-gray-50"
                  />
                </div>
                <div>
                  <label class="block text-xs text-gray-500 mb-1">등록일</label>
                  <input
                    type="text"
                    id="detail-date"
                    class="w-full border border-gray-300 rounded px-3 py-2 text-sm bg-gray-50"
                    readonly
                  />
                </div>
              </div>
            </div>
          </div>

          <!-- 노출 설정 -->
          <div class="bg-white rounded-lg border border-gray-200 p-4">
            <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
              <span class="w-1 h-4 bg-green-500 rounded"></span>
              노출 설정
            </h3>
            <div class="space-y-3">
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs text-gray-500 mb-1">노출 시작일</label>
                  <input
                    type="date"
                    id="detail-start-date"
                    class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                <div>
                  <label class="block text-xs text-gray-500 mb-1">노출 종료일</label>
                  <input
                    type="date"
                    id="detail-end-date"
                    class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500"
                  />
                </div>
              </div>
              <div class="flex items-center gap-3">
                <label class="block text-xs text-gray-500">노출 상태</label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    id="detail-active"
                    class="w-4 h-4 rounded text-blue-500"
                  />
                  <span class="text-sm text-gray-700">노출</span>
                </label>
              </div>
            </div>
          </div>

          <!-- 내용 -->
          <div class="bg-white rounded-lg border border-gray-200 p-4">
            <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
              <span class="w-1 h-4 bg-purple-500 rounded"></span>
              내용 <span class="text-red-500">*</span>
            </h3>
            <div id="editor-container"></div>
            <p class="mt-2 text-xs text-gray-400">
              표 삽입, 텍스트 서식, HTML 모드를 사용하실 수 있습니다.
            </p>
          </div>

          <!-- 첨부파일 -->
          <div class="bg-white rounded-lg border border-gray-200 p-4">
            <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
              <span class="w-1 h-4 bg-orange-500 rounded"></span>
              첨부파일
            </h3>
            <div class="space-y-2" id="attachment-list">
              <!-- 동적으로 생성됨 -->
            </div>
            <label class="block mt-2">
              <span class="inline-flex items-center px-4 py-2 bg-blue-500 text-white rounded text-sm font-medium hover:bg-blue-600 cursor-pointer">
                파일 추가
                <input type="file" class="hidden" multiple onchange="handleFileAdd(event)" />
              </span>
            </label>
          </div>

          <!-- 노출 사이트 -->
          <div class="bg-white rounded-lg border border-gray-200 p-4">
            <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
              <span class="w-1 h-4 bg-indigo-500 rounded"></span>
              노출 사이트 <span class="text-red-500">*</span>
            </h3>
            <div class="flex flex-wrap gap-2" id="site-buttons">
              <!-- 동적으로 생성됨 -->
            </div>
            <p class="mt-2 text-xs text-gray-400">
              '전체' 선택 시 모든 사이트에 팝업이 노출됩니다.
            </p>
          </div>

          <!-- 관련 팝업 -->
          <div id="related-popups-section" class="hidden bg-white rounded-lg border border-gray-200 p-4">
            <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
              <span class="w-1 h-4 bg-gray-500 rounded"></span>
              관련 팝업
            </h3>
            <div class="space-y-2" id="related-popups">
              <!-- 동적으로 생성됨 -->
            </div>
          </div>
        </div>

        <!-- 패널 푸터 -->
        <div class="bg-white border-t border-gray-200 px-6 py-4 flex items-center justify-between shrink-0">
          <button
            id="detail-delete-btn"
            onclick="deleteCurrentPopup()"
            class="hidden px-4 py-2 border border-red-500 text-red-500 rounded text-sm font-medium hover:bg-red-50"
          >
            삭제
          </button>
          <div id="detail-delete-placeholder"></div>
          <div class="flex gap-2">
            <button
              onclick="closeDetailPanel()"
              class="px-4 py-2 border border-gray-300 text-gray-700 rounded text-sm font-medium hover:bg-gray-50"
            >
              취소
            </button>
            <button
              id="detail-save-btn"
              onclick="savePopup()"
              class="px-6 py-2 bg-blue-500 text-white rounded text-sm font-medium hover:bg-blue-600"
            >
              저장
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 데이터
    const sites = ['전체', 'TG', 'TG&Co', 'EPSON', 'FUJI XEROX', 'Amway', 'Huawei', 'ZTE', 'Lenovo', 'EZVIZ', 'LOGITECH', '이마트'];

    const popups = [
      {
        id: 10,
        title: '2023 lenovo MSD 메뉴얼(최신버전)',
        content: '<p>2023 lenovo MSD 메뉴얼</p><p>-MSD Case 및 WO 접수시 신규 업데이트 된 부분 모두 적용</p>',
        author: '김은화',
        createdAt: '2023-04-21 17:21:27',
        exposureStart: '2023-04-21',
        exposureEnd: '',
        views: 19,
        hasAttachment: true,
        attachments: ['2023_lenovo_MSD_manual.pdf'],
        sites: ['전체'],
        isActive: true
      },
      {
        id: 9,
        title: 'LENOVO DEPOT WORK ORDER 전산 업데이트 메뉴얼',
        content: '<p>LENOVO DEPOT WORK ORDER 전산 업데이트 관련 메뉴얼입니다.</p>',
        author: '김은화',
        createdAt: '2023-03-20 10:30:00',
        exposureStart: '2023-03-20',
        exposureEnd: '',
        views: 7,
        hasAttachment: true,
        attachments: ['LENOVO_DEPOT_WORK_ORDER.pdf'],
        sites: ['Lenovo'],
        isActive: true
      },
      {
        id: 8,
        title: 'ADP CRM 등록방법',
        content: '<p>ADP CRM 등록 방법에 대한 안내입니다.</p>',
        author: '최두현',
        createdAt: '2019-05-15 09:00:00',
        exposureStart: '2019-05-15',
        exposureEnd: '',
        views: 25,
        hasAttachment: true,
        attachments: ['ADP_CRM_guide.pdf'],
        sites: ['TG', 'TG&Co'],
        isActive: true
      },
      {
        id: 7,
        title: 'LENOVO 내근 추가파트 메뉴얼',
        content: '<p>LENOVO 내근 추가파트 처리 메뉴얼입니다.</p>',
        author: '최두현',
        createdAt: '2019-05-15 09:00:00',
        exposureStart: '2019-05-15',
        exposureEnd: '',
        views: 22,
        hasAttachment: true,
        attachments: ['LENOVO_parts_manual.pdf'],
        sites: ['Lenovo'],
        isActive: true
      },
      {
        id: 6,
        title: 'lenovo (외근) CCI 1.5에서 ONS CLOSE 방법-한글버전',
        content: '<p>lenovo 외근 CCI 1.5에서 ONS CLOSE 방법에 대한 한글 메뉴얼입니다.</p>',
        author: '최두현',
        createdAt: '2019-05-15 09:00:00',
        exposureStart: '2019-05-15',
        exposureEnd: '',
        views: 13,
        hasAttachment: true,
        attachments: ['lenovo_CCI_ONS_CLOSE.pdf'],
        sites: ['Lenovo'],
        isActive: true
      },
      {
        id: 5,
        title: 'LENOVO 내근 DOA 신청 메뉴얼',
        content: '<p>LENOVO 내근 DOA 신청 방법에 대한 메뉴얼입니다.</p>',
        author: '최두현',
        createdAt: '2019-05-15 09:00:00',
        exposureStart: '2019-05-15',
        exposureEnd: '',
        views: 20,
        hasAttachment: true,
        attachments: ['LENOVO_DOA_request.pdf'],
        sites: ['Lenovo'],
        isActive: false
      },
      {
        id: 4,
        title: 'LENOVO 내근 DOA CLOSE 및 파트 반납 메뉴얼',
        content: '<p>LENOVO 내근 DOA CLOSE 및 파트 반납 절차 메뉴얼입니다.</p>',
        author: '최두현',
        createdAt: '2019-05-15 09:00:00',
        exposureStart: '2019-05-15',
        exposureEnd: '',
        views: 9,
        hasAttachment: false,
        attachments: [],
        sites: ['Lenovo'],
        isActive: true
      },
      {
        id: 3,
        title: '점검 후 무상에서 유상으로 변경되어 전산 Cancel시 선택방법',
        content: '<p>점검 후 무상에서 유상으로 변경되어 전산 Cancel시 선택하는 방법입니다.</p>',
        author: '최두현',
        createdAt: '2019-05-15 09:00:00',
        exposureStart: '2019-05-15',
        exposureEnd: '2020-12-31',
        views: 126,
        hasAttachment: false,
        attachments: [],
        sites: ['전체'],
        isActive: false
      },
      {
        id: 2,
        title: 'Lenovo 업무메뉴얼_CRM(환입설명)',
        content: '<p>Lenovo 업무 메뉴얼 중 CRM 환입 설명 자료입니다.</p>',
        author: '최두현',
        createdAt: '2019-05-15 09:00:00',
        exposureStart: '2019-05-15',
        exposureEnd: '',
        views: 151,
        hasAttachment: true,
        attachments: ['Lenovo_CRM_manual.pdf'],
        sites: ['Lenovo'],
        isActive: true
      }
    ];

    // 상태
    let selectedRows = [];
    let currentPopup = null;
    let currentPage = 1;
    const ITEMS_PER_PAGE = 10;
    let editor = null; // CKEditor 인스턴스

    // 초기화
    function init() {
      applyFilters();
      initCKEditor();
      
      // 검색 필터 이벤트
      document.getElementById('search-keyword').addEventListener('input', () => {
        currentPage = 1;
        applyFilters();
      });
      document.getElementById('search-type').addEventListener('change', applyFilters);
      document.getElementById('search-site').addEventListener('change', () => {
        currentPage = 1;
        applyFilters();
      });
    }

    // CKEditor 초기화
    function initCKEditor() {
      ClassicEditor
        .create(document.querySelector('#editor-container'), {
          language: 'ko',
          toolbar: {
            items: [
              'heading', '|',
              'fontSize', 'fontFamily', 'fontColor', 'fontBackgroundColor', '|',
              'bold', 'italic', 'underline', 'strikethrough', '|',
              'alignment', '|',
              'numberedList', 'bulletedList', '|',
              'indent', 'outdent', '|',
              'link', 'insertTable', 'blockQuote', '|',
              'undo', 'redo', '|',
              'sourceEditing'
            ]
          },
          table: {
            contentToolbar: ['tableColumn', 'tableRow', 'mergeTableCells', 'tableProperties', 'tableCellProperties']
          },
          fontSize: {
            options: [9, 10, 11, 12, 14, 16, 18, 20, 22, 24, 26, 28, 36, 48, 72]
          },
          fontFamily: {
            options: [
              'default',
              '돋움',
              '굴림',
              '맑은 고딕',
              'Arial',
              'Courier New',
              'Georgia',
              'Times New Roman',
              'Verdana'
            ]
          },
          heading: {
            options: [
              { model: 'paragraph', title: '본문', class: 'ck-heading_paragraph' },
              { model: 'heading1', view: 'h1', title: '제목 1', class: 'ck-heading_heading1' },
              { model: 'heading2', view: 'h2', title: '제목 2', class: 'ck-heading_heading2' },
              { model: 'heading3', view: 'h3', title: '제목 3', class: 'ck-heading_heading3' }
            ]
          },
          placeholder: '팝업에 표시할 내용을 입력하세요. 표 삽입, 텍스트 서식, HTML 모드를 사용하실 수 있습니다.'
        })
        .then(newEditor => {
          editor = newEditor;
          editor.setData('');
        })
        .catch(error => {
          console.error('CKEditor initialization error:', error);
        });
    }

    // 필터 적용
    function applyFilters() {
      const searchType = document.getElementById('search-type').value;
      const searchKeyword = document.getElementById('search-keyword').value.toLowerCase();
      const searchSite = document.getElementById('search-site').value;

      let filtered = popups.filter(popup => {
        const matchKeyword = !searchKeyword || (
          searchType === 'title' ? popup.title.toLowerCase().includes(searchKeyword) :
          searchType === 'author' ? popup.author.toLowerCase().includes(searchKeyword) :
          searchType === 'content' ? popup.content.toLowerCase().includes(searchKeyword) :
          false
        );
        const matchSite = !searchSite || popup.sites.includes(searchSite) || popup.sites.includes('전체');
        return matchKeyword && matchSite;
      });

      renderTable(filtered);
      renderPagination(filtered);
      updateTotalCount(filtered.length);
    }

    // 테이블 렌더링
    function renderTable(filteredPopups) {
      const tbody = document.getElementById('popup-tbody');
      const emptyState = document.getElementById('empty-state');
      
      const totalPages = Math.ceil(filteredPopups.length / ITEMS_PER_PAGE);
      const startIdx = (currentPage - 1) * ITEMS_PER_PAGE;
      const endIdx = startIdx + ITEMS_PER_PAGE;
      const pagePopups = filteredPopups.slice(startIdx, endIdx);
      
      if (pagePopups.length === 0) {
        tbody.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }
      
      emptyState.classList.add('hidden');
      
      tbody.innerHTML = pagePopups.map(popup => {
        const formattedDate = popup.createdAt.split(' ')[0];
        
        return `
          <tr
            onclick="selectPopup(${popup.id})"
            class="border-b border-gray-100 cursor-pointer transition-colors ${
              currentPopup?.id === popup.id ? 'bg-blue-50' : 'hover:bg-gray-50'
            }"
          >
            <td class="py-3 px-3 text-center" onclick="event.stopPropagation()">
              <input
                type="checkbox"
                ${selectedRows.includes(popup.id) ? 'checked' : ''}
                onchange="toggleRow(${popup.id})"
                class="w-4 h-4 rounded"
              />
            </td>
            <td class="py-3 px-3 text-gray-500">${popup.id}</td>
            <td class="py-3 px-3">
              <p class="font-medium truncate max-w-md ${currentPopup?.id === popup.id ? 'text-blue-700' : 'text-gray-800'}">
                ${popup.title}
              </p>
              <div class="flex gap-1 mt-1">
                ${popup.sites.slice(0, 3).map(site => `
                  <span class="px-1.5 py-0.5 bg-gray-100 text-gray-500 rounded text-xs">${site}</span>
                `).join('')}
                ${popup.sites.length > 3 ? `<span class="px-1.5 py-0.5 bg-gray-100 text-gray-500 rounded text-xs">+${popup.sites.length - 3}</span>` : ''}
              </div>
            </td>
            <td class="py-3 px-3 text-gray-500 text-xs">${formattedDate}</td>
            <td class="py-3 px-3 text-gray-600">${popup.author}</td>
            <td class="py-3 px-3 text-center">
              ${popup.hasAttachment ? `
                <svg class="w-5 h-5 text-yellow-500 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                </svg>
              ` : ''}
            </td>
            <td class="py-3 px-3 text-center text-gray-500">${popup.views}</td>
            <td class="py-3 px-3 text-center">
              <span class="px-2 py-0.5 rounded text-xs font-medium ${
                popup.isActive ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-500'
              }">
                ${popup.isActive ? '노출' : '중지'}
              </span>
            </td>
          </tr>
        `;
      }).join('');
      
      updateSelectAllCheckbox(pagePopups);
    }

    // 페이지네이션 렌더링
    function renderPagination(filteredPopups) {
      const totalPages = Math.ceil(filteredPopups.length / ITEMS_PER_PAGE);
      
      const startIdx = (currentPage - 1) * ITEMS_PER_PAGE + 1;
      const endIdx = Math.min(currentPage * ITEMS_PER_PAGE, filteredPopups.length);
      
      document.getElementById('pagination-info').textContent = 
        filteredPopups.length > 0 ? `${startIdx}-${endIdx} / ${filteredPopups.length}건` : '0건';
      
      if (totalPages <= 1) {
        document.getElementById('pagination-buttons').innerHTML = '<div></div>';
        return;
      }
      
      const maxVisible = 5;
      let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
      let end = Math.min(totalPages, start + maxVisible - 1);
      
      if (end - start + 1 < maxVisible) {
        start = Math.max(1, end - maxVisible + 1);
      }
      
      let pages = [];
      for (let i = start; i <= end; i++) {
        pages.push(i);
      }
      
      const buttonsHtml = `
        <button
          onclick="goToPage(1)"
          ${currentPage === 1 ? 'disabled' : ''}
          class="px-2 py-1 text-xs rounded ${currentPage === 1 ? 'text-gray-300' : 'text-gray-600 hover:bg-gray-100'}"
        >«</button>
        <button
          onclick="goToPage(${Math.max(1, currentPage - 1)})"
          ${currentPage === 1 ? 'disabled' : ''}
          class="px-2 py-1 text-xs rounded ${currentPage === 1 ? 'text-gray-300' : 'text-gray-600 hover:bg-gray-100'}"
        >‹</button>
        ${pages.map(p => `
          <button
            onclick="goToPage(${p})"
            class="px-2.5 py-1 text-xs rounded ${p === currentPage ? 'bg-blue-500 text-white' : 'text-gray-600 hover:bg-gray-100'}"
          >${p}</button>
        `).join('')}
        <button
          onclick="goToPage(${Math.min(totalPages, currentPage + 1)})"
          ${currentPage === totalPages ? 'disabled' : ''}
          class="px-2 py-1 text-xs rounded ${currentPage === totalPages ? 'text-gray-300' : 'text-gray-600 hover:bg-gray-100'}"
        >›</button>
        <button
          onclick="goToPage(${totalPages})"
          ${currentPage === totalPages ? 'disabled' : ''}
          class="px-2 py-1 text-xs rounded ${currentPage === totalPages ? 'text-gray-300' : 'text-gray-600 hover:bg-gray-100'}"
        >»</button>
      `;
      
      document.getElementById('pagination-buttons').innerHTML = buttonsHtml;
    }

    // 페이지 이동
    function goToPage(page) {
      currentPage = page;
      applyFilters();
    }

    // 총 개수 업데이트
    function updateTotalCount(count) {
      document.getElementById('total-count').textContent = count;
    }

    // 행 선택
    function toggleRow(id) {
      if (selectedRows.includes(id)) {
        selectedRows = selectedRows.filter(i => i !== id);
      } else {
        selectedRows.push(id);
      }
      updateSelectedCount();
      applyFilters();
    }

    // 전체 선택
    function toggleSelectAll() {
      const searchType = document.getElementById('search-type').value;
      const searchKeyword = document.getElementById('search-keyword').value.toLowerCase();
      const searchSite = document.getElementById('search-site').value;

      let filtered = popups.filter(popup => {
        const matchKeyword = !searchKeyword || (
          searchType === 'title' ? popup.title.toLowerCase().includes(searchKeyword) :
          searchType === 'author' ? popup.author.toLowerCase().includes(searchKeyword) :
          searchType === 'content' ? popup.content.toLowerCase().includes(searchKeyword) :
          false
        );
        const matchSite = !searchSite || popup.sites.includes(searchSite) || popup.sites.includes('전체');
        return matchKeyword && matchSite;
      });

      const pagePopups = filtered.slice((currentPage - 1) * ITEMS_PER_PAGE, currentPage * ITEMS_PER_PAGE);
      const pageIds = pagePopups.map(p => p.id);
      
      const allSelected = pageIds.every(id => selectedRows.includes(id));
      
      if (allSelected) {
        selectedRows = selectedRows.filter(id => !pageIds.includes(id));
      } else {
        selectedRows = [...new Set([...selectedRows, ...pageIds])];
      }
      
      updateSelectedCount();
      applyFilters();
    }

    // 전체 선택 체크박스 업데이트
    function updateSelectAllCheckbox(pagePopups) {
      const selectAll = document.getElementById('select-all');
      const pageIds = pagePopups.map(p => p.id);
      selectAll.checked = pagePopups.length > 0 && pageIds.every(id => selectedRows.includes(id));
    }

    // 선택 개수 업데이트
    function updateSelectedCount() {
      document.getElementById('selected-count').textContent = selectedRows.length;
      const deleteBtn = document.getElementById('delete-btn');
      
      if (selectedRows.length > 0) {
        deleteBtn.className = 'px-3 py-1.5 border rounded text-xs font-medium border-red-500 text-red-500 hover:bg-red-50';
      } else {
        deleteBtn.className = 'px-3 py-1.5 border rounded text-xs font-medium border-gray-300 text-gray-400';
      }
    }

    // 검색 초기화
    function resetSearch() {
      document.getElementById('search-type').value = 'title';
      document.getElementById('search-keyword').value = '';
      document.getElementById('search-site').value = '';
      currentPage = 1;
      applyFilters();
    }

    // 팝업 선택
    function selectPopup(id) {
      const popup = popups.find(p => p.id === id);
      if (popup) {
        openDetailPanel(popup);
      }
    }

    // 신규 팝업
    function openNewPopup() {
      const today = new Date().toISOString().split('T')[0];
      openDetailPanel({
        id: null,
        title: '',
        content: '',
        author: '관리자',
        createdAt: today,
        exposureStart: '',
        exposureEnd: '',
        views: 0,
        hasAttachment: false,
        attachments: [],
        sites: [],
        isActive: true
      });
    }

    // 상세 패널 열기
    function openDetailPanel(popup) {
      currentPopup = { ...popup };
      
      const listPanel = document.getElementById('list-panel');
      const detailPanel = document.getElementById('detail-panel');
      
      listPanel.className = 'w-1/2 bg-white flex flex-col h-full transition-all';
      detailPanel.classList.remove('hidden');
      
      // 헤더
      if (popup.id) {
        document.getElementById('detail-title').textContent = '팝업 수정';
        document.getElementById('detail-subtitle').textContent = `조회수 ${popup.views}회`;
        document.getElementById('detail-delete-btn').classList.remove('hidden');
        document.getElementById('detail-delete-placeholder').innerHTML = '';
        document.getElementById('detail-save-btn').textContent = '수정';
      } else {
        document.getElementById('detail-title').textContent = '신규 팝업 등록';
        document.getElementById('detail-subtitle').textContent = '';
        document.getElementById('detail-delete-btn').classList.add('hidden');
        document.getElementById('detail-delete-placeholder').innerHTML = '<div></div>';
        document.getElementById('detail-save-btn').textContent = '등록';
      }
      
      // 폼 채우기
      document.getElementById('detail-title-input').value = popup.title;
      document.getElementById('detail-author').value = popup.author;
      document.getElementById('detail-date').value = popup.createdAt.split(' ')[0];
      document.getElementById('detail-start-date').value = popup.exposureStart || '';
      document.getElementById('detail-end-date').value = popup.exposureEnd || '';
      document.getElementById('detail-active').checked = popup.isActive;
      
      // CKEditor 내용 설정
      if (editor) {
        editor.setData(popup.content || '');
      }
      
      // 첨부파일 렌더링
      renderAttachments(popup.attachments || []);
      
      // 사이트 버튼 렌더링
      renderSiteButtons(popup.sites || []);
      
      // 관련 팝업
      if (popup.id) {
        renderRelatedPopups(popup);
      } else {
        document.getElementById('related-popups-section').classList.add('hidden');
      }
    }

    // 첨부파일 렌더링
    function renderAttachments(attachments) {
      const container = document.getElementById('attachment-list');
      
      if (attachments.length === 0) {
        container.innerHTML = `
          <div class="text-center py-4 text-gray-400 text-sm border border-dashed border-gray-300 rounded">
            첨부된 파일이 없습니다
          </div>
        `;
      } else {
        container.innerHTML = attachments.map((file, idx) => `
          <div class="flex items-center justify-between bg-gray-50 rounded p-3 border border-gray-200">
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
              </svg>
              <span class="text-sm text-gray-700">${file}</span>
            </div>
            <button 
              onclick="removeAttachment(${idx})"
              class="px-2 py-1 text-xs text-red-500 hover:bg-red-50 rounded border border-red-200"
            >
              삭제
            </button>
          </div>
        `).join('');
      }
    }

    // 사이트 버튼 렌더링
    function renderSiteButtons(selectedSites) {
      const container = document.getElementById('site-buttons');
      
      container.innerHTML = sites.map(site => {
        const isSelected = selectedSites.includes(site);
        return `
          <button
            onclick="toggleSite('${site}')"
            class="px-3 py-1.5 rounded text-xs font-medium transition-all ${
              isSelected
                ? 'bg-blue-500 text-white'
                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
            }"
          >
            ${isSelected ? '✓ ' : ''}${site}
          </button>
        `;
      }).join('');
    }

    // 사이트 토글
    function toggleSite(site) {
      if (!currentPopup) return;
      
      if (site === '전체') {
        currentPopup.sites = currentPopup.sites.includes('전체') ? [] : ['전체'];
      } else {
        if (currentPopup.sites.includes(site)) {
          currentPopup.sites = currentPopup.sites.filter(s => s !== site);
        } else {
          currentPopup.sites = [...currentPopup.sites.filter(s => s !== '전체'), site];
        }
      }
      
      renderSiteButtons(currentPopup.sites);
    }

    // 관련 팝업 렌더링
    function renderRelatedPopups(popup) {
      const relatedSection = document.getElementById('related-popups-section');
      const container = document.getElementById('related-popups');
      
      const related = popups
        .filter(p => p.id !== popup.id && p.sites.some(s => popup.sites.includes(s)))
        .slice(0, 3);
      
      if (related.length === 0) {
        relatedSection.classList.add('hidden');
        return;
      }
      
      relatedSection.classList.remove('hidden');
      
      container.innerHTML = related.map(p => `
        <div 
          onclick="selectPopup(${p.id})"
          class="flex items-center justify-between p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer"
        >
          <div>
            <p class="text-sm text-gray-700 truncate max-w-xs">${p.title}</p>
            <p class="text-xs text-gray-400">${p.createdAt.split(' ')[0]} · ${p.author}</p>
          </div>
          <span class="text-xs text-gray-400">조회 ${p.views}</span>
        </div>
      `).join('');
    }

    // 첨부파일 제거
    function removeAttachment(idx) {
      if (!currentPopup) return;
      currentPopup.attachments = currentPopup.attachments.filter((_, i) => i !== idx);
      renderAttachments(currentPopup.attachments);
    }

    // 파일 추가
    function handleFileAdd(event) {
      const files = Array.from(event.target.files);
      if (!currentPopup) return;
      
      const newFiles = files.map(f => f.name);
      currentPopup.attachments = [...(currentPopup.attachments || []), ...newFiles];
      renderAttachments(currentPopup.attachments);
      
      // input 초기화
      event.target.value = '';
    }

    // 상세 패널 닫기
    function closeDetailPanel() {
      const listPanel = document.getElementById('list-panel');
      const detailPanel = document.getElementById('detail-panel');
      
      listPanel.className = 'w-full bg-white flex flex-col h-full transition-all';
      detailPanel.classList.add('hidden');
      
      currentPopup = null;
      applyFilters();
    }

    // 삭제 선택된 항목
    function deleteSelected() {
      if (selectedRows.length === 0) return;
      
      if (confirm(`선택한 ${selectedRows.length}개의 팝업을 삭제하시겠습니까?`)) {
        if (currentPopup && selectedRows.includes(currentPopup.id)) {
          closeDetailPanel();
        }
        selectedRows = [];
        updateSelectedCount();
        applyFilters();
        alert('삭제되었습니다.');
      }
    }

    // 현재 팝업 삭제
    function deleteCurrentPopup() {
      if (!currentPopup || !currentPopup.id) return;
      
      if (confirm('이 팝업을 삭제하시겠습니까?')) {
        closeDetailPanel();
        alert('삭제되었습니다.');
      }
    }

    // 저장
    function savePopup() {
      const title = document.getElementById('detail-title-input').value;
      const content = editor ? editor.getData() : '';
      
      if (!title) {
        alert('제목을 입력해주세요.');
        return;
      }
      
      if (!content) {
        alert('내용을 입력해주세요.');
        return;
      }
      
      if (!currentPopup.sites || currentPopup.sites.length === 0) {
        alert('노출 사이트를 선택해주세요.');
        return;
      }
      
      if (currentPopup && currentPopup.id) {
        alert('팝업이 수정되었습니다.');
      } else {
        alert('새 팝업이 등록되었습니다.');
      }
      
      closeDetailPanel();
    }

    // 초기화 실행
    init();
  </script>
</body>
</html>
